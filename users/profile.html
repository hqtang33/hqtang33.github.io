<!DOCTYPE HTML>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Stamina &mdash; Free Website Template, Free HTML5 Template by freehtml5.co</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Free HTML5 Website Template by freehtml5.co" />
  <meta name="keywords" content="free website templates, free html5, free template, free bootstrap, free website template, html5, css3, mobile first, responsive" />
  <meta name="author" content="freehtml5.co" />
  <style type="text/css">

  </style>
  <!--
	//////////////////////////////////////////////////////

	FREE HTML5 TEMPLATE
	DESIGNED & DEVELOPED by FreeHTML5.co

	Website: 		http://freehtml5.co/
	Email: 			info@freehtml5.co
	Twitter: 		http://twitter.com/fh5co
	Facebook: 		https://www.facebook.com/fh5co

	//////////////////////////////////////////////////////
	 -->

  <!-- Facebook and Twitter integration -->
  <meta property="og:title" content="" />
  <meta property="og:image" content="" />
  <meta property="og:url" content="" />
  <meta property="og:site_name" content="" />
  <meta property="og:description" content="" />
  <meta name="twitter:title" content="" />
  <meta name="twitter:image" content="" />
  <meta name="twitter:url" content="" />
  <meta name="twitter:card" content="" />

  <link href="https://fonts.googleapis.com/css?family=Work+Sans:300,400,500,700,800" rel="stylesheet">

  <!-- Animate.css -->
  <link rel="stylesheet" href="/css/animate.css">
  <!-- Font Awesome -->
  <link href="/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <!-- Icomoon Icon Fonts-->
  <link rel="stylesheet" href="/css/icomoon.css">
  <!-- Bootstrap  -->
  <link rel="stylesheet" href="/bootstrap/css/bootstrap.css">

  <!-- Magnific Popup -->
  <link rel="stylesheet" href="/css/magnific-popup.css">

  <!-- Owl Carousel  -->
  <link rel="stylesheet" href="/css/owl.carousel.min.css">
  <link rel="stylesheet" href="/css/owl.theme.default.min.css">

  <!-- Theme style  -->
  <link rel="stylesheet" href="/css/style.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/custom.css">

  <!-- Modernizr JS -->
  <script src="/js/modernizr-2.6.2.min.js"></script>
  <!-- FOR IE9 below -->
  <!--[if lt IE 9]>
	<script src="js/respond.min.js"></script>
	<![endif]-->
  <!-- Admin Page CSS -->
  <link rel="stylesheet" href="../css/admin.css">

</head>

<body>

  <div class="fh5co-loader"></div>

  <div id="page">
    <nav id="header" class="fh5co-nav" role="navigation"></nav>

    <nav class="setting-nav">
      <div class="container">
        <div class="row">
          <div class="col-xs-12 text-center setting-title">
            <p>Users</p>
          </div>
        </div>
      </div>
    </nav>
    <div class="setting-content profile-content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-lg-2 col-lg-offset-1 col-md-12 col-sm-12 col-xs-12">
            <div class="profile-box profile-box-settings">
              <div class="button-box">
                <button href="#subscribe-plan-popup" type="button" id="btn-responsive" class="subscribe-plan-popup">Subscribe new plan</button>
              </div>
              <div class="button-box">
                <button href="#insert-picture-popup" type="button" id="btn-responsive" class="insert-picture-popup">Change Profile Picture</button>
              </div>
              <div class="button-box">
                <button href="#change-address-popup" type="button" id="btn-responsive" class="change-address-popup">Change Address</button>
              </div>

            </div>
          </div>
          <div class="col-lg-2 col-md-4 col-xs-12 col-sm-12">
            <div class="profile-box">
              <h1 class="text-center">Your Account</h1>
              <div class="profile-picture">
                <img alt="profile_picture" id="profile-picture" class="img-responsive img-circle" src="">
              </div>
              <h2 class="text-center" id="profile-name"></h2>

            </div>
          </div>
          <div class="col-lg-3 col-md-4 col-sm-12 col-xs-12">
            <div class="profile-box">
              <h1 class="text-center">Personal Info</h1>
              <div class="info">
                <p class="title-field">Email:</p>
                <p id="profile-email" class="data-field"></p>
                <p class="title-field">NRIC:</p>
                <p id="profile-nric" class="data-field"></p>
                <p class="title-field">Address:</p>
                <p id="profile-address" class="data-field"></p>
              </div>
            </div>
          </div>
          <div class="col-lg-3 col-md-4 col-sm-12 col-xs-12">
            <div class="profile-box">
              <h1 class="text-center">Membership</h1>
              <div class="info" id="membership-info"></div>
            </div>
          </div>




        </div>
      </div>

    </div>

    <div id="footer"></div>

    <!--- Popup content -->
    <!--- Change Picture --->
    <div id="insert-picture-popup" class="white-popup mfp-hide">
      <form id="change-picture-form">
        <p class="title-field">Upload your profile picture</p>
        <p class="data-field">Current profile picture</p>
        <div class="profile-picture"><img class="img-circle img-responsive" id="display-profile-picture"></div>
        <input type="file" accept="image/*" id="js-profile-picture">
        <br>
        <div id="success-in-popup" class="alert alert-success" hidden></div>
        <button type="button" id="btn-upload" class="btn btn-primary">Upload</button>
      </form>
    </div>
    <!--- Change Address --->
    <div id="change-address-popup" class="white-popup mfp-hide">
      <p class="title-field">Change your address</p>
      <label>Address<textarea id="js-new-address" rows="5" cols="80" class="form-control"></textarea></label>
      <br><br>
      <div id="success-in-popup" class="alert alert-success" hidden></div>
      <button type="button" id="btn-change-address" class="btn btn-primary">Update</button>
    </div>
  </div>
  <!--- Subscribe new Plan --->
  <div id="subscribe-plan-popup" class="white-popup mfp-hide">
    <h2 class="title-field" style="text-decoration:none;">Subscribe new Plan</h2>
    <form id="add-service-form" hidden>
      <div class="row form-group">
        <div class="col-md-12" id="select-plan-div">
          <label>Select Plan</label>
          <select id="js-selected-plan" class="form-control">
            <option disabled selected> -- select a plan -- </option>
          </select>
        </div>

      </div>
      <div class="row form-group">
        <div class="col-md-12">
          <label>Plan Description</label>
          <p id="display-plan-description"></p>
        </div>

      </div>
      <div id="success-in-popup" class="alert alert-success" hidden></div>
      <div class="form-group">
        <button type="button" id="btn-add-subscribe" class="btn btn-primary">Subscribe</button>
      </div>
    </form>
    <h4 id="plan-exist-alert"></h4>
  </div>
  </div>


  <div class="gototop js-top">
    <a href="#" class="js-gotop"><i class="icon-arrow-up"></i></a>
  </div>

  <!-- jQuery -->
  <script src="/js/jquery.min.js"></script>
  <!-- jQuery Easing -->
  <script src="/js/jquery.easing.1.3.js"></script>
  <!-- Bootstrap -->
  <script src="/js/bootstrap.min.js"></script>
  <!-- Waypoints -->
  <script src="/js/jquery.waypoints.min.js"></script>
  <!-- Stellar Parallax -->
  <script src="/js/jquery.stellar.min.js"></script>
  <!-- Carousel -->
  <script src="/js/owl.carousel.min.js"></script>
  <!-- countTo -->
  <script src="/js/jquery.countTo.js"></script>
  <!-- Magnific Popup -->
  <script src="/js/jquery.magnific-popup.min.js"></script>
  <script src="/js/magnific-popup-options.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
  <!-- Main -->
  <script src="../js/main.js"></script>
  <!-- Custom -->
  <script src="../js/custom.js"></script>
  <script type="text/javascript">
    $(function() {
      $("#header").load("/header.html");
      $("#footer").load("/footer.html");

      $('.subscribe-plan-popup').magnificPopup({
        type: 'inline',
        midClick: true, // Allow opening popup on middle mouse click. Always set it to true if you don't provide alternative source in href.
        callbacks: {
          open: function() {
            firebase.auth().onAuthStateChanged(user => {
              if (user) {
                var userID = user.uid;
                var memPlanRef = firebase.database().ref('/membership_Plan/');
                memPlanRef.once('value', function(snapshot) {
                  var existPlan = snapshot.child(userID).exists();
                  if (!existPlan) {
                    $("#add-service-form").show();

                    /*--- Trainer Gather ---*/
                    var memInfoRef = firebase.database().ref('/membership_Info/');
                    memInfoRef.once('value', function(data) {
                      var membership_Info = data.val();
                      /* --- console.log(account_Info); ---*/
                      var keys = Object.keys(membership_Info);

                      for (var i = 0; i < keys.length; i++) {
                        var t = keys[i];
                        $("#js-selected-plan").append("<option value=\"" + membership_Info[t].membershipId + "\">" +
                          membership_Info[t].membershipName + "</option>");
                        $("#select-plan-div").append("<input type=\"hidden\" id=\"hidn" + membership_Info[t].membershipId + "\" value=\"" + membership_Info[t].membershipDesc + "\">");
                      }
                      $("#js-selected-plan").change(function() {
                        $("#display-plan-description").text(membership_Info[$(this).val()].membershipDesc);
                      });

                      /*here*/
                      $("#btn-add-subscribe").on("click", function(e) {
                        var subPlan = new Object();
                        updates = {};
                        subPlan.member_type = $("#js-selected-plan").val();
                        subPlan.member_start = getDateString(getToday());
                        if (membership_Info[subPlan.member_type].membershipType == "contract") {
                          subPlan.member_end = getDateString(getTarget(membership_Info[subPlan.member_type].membershipMonth));
                        } else if (membership_Info[subPlan.member_type].membershipType == "prepaid") {
                          subPlan.member_end = getDateString(getTarget(1));
                        }
                        updates['/membership_Plan/' + userID] = subPlan;
                        firebase.database().ref().update(updates).then(function() {
                          alert("Can");
                          $("#js-selected-plan").attr("disabled", "disabled");
                          $("#subscribe-plan-popup #success-in-popup").text("Thank you for you subscription").show();

                        });
                      });


                    });
                  } else {
                    $("#add-service-form").hide();
                    $("#plan-exist-alert").text("Subscription currently exist! Please wait until your current plan expired.");
                  }
                });
              }
            });


          },
          close: function() {
            // Will fire when popup is closed
            $("#success-in-popup").hide();
            $("#change-picture-form").trigger("reset");
          }
        }
      });


      $('.insert-picture-popup').magnificPopup({
        type: 'inline',
        midClick: true, // Allow opening popup on middle mouse click. Always set it to true if you don't provide alternative source in href.
        callbacks: {
          open: function() {
            $("#btn-upload").on("click", function(e) {
              e.preventDefault();
              var file = $("#js-profile-picture")[0].files[0];
              var userID = firebase.auth().currentUser.uid;
              var database = firebase.database().ref('/account_Info/' + userID);
              firebase.storage().ref('profile_picture/' + userID + '_profilePic.jpg').put(file).then(function(snapshot) {
                var url = snapshot.downloadURL;
                database.update({
                  profilePic: url
                });
                $("#display-profile-picture").attr("src", url);
                $("#profile-picture").attr("src", url);
                $("#success-in-popup").text("Profile picture updated.").show();
              });
            });
          },
          close: function() {
            // Will fire when popup is closed
            $("#success-in-popup").hide();
            $("#change-picture-form").trigger("reset");
          }
        }
      });

      $('.change-address-popup').magnificPopup({
        type: 'inline',
        midClick: true, // Allow opening popup on middle mouse click. Always set it to true if you don't provide alternative source in href.
        callbacks: {
          open: function() {
            firebase.auth().onAuthStateChanged(user => {
              if (user) {
                var userID = user.uid;
                var accInfoRef = firebase.database().ref('/account_Info/' + userID);
                accInfoRef.once('value', function(data) {
                  var userProfile = data.val();
                  $("#js-new-address").val(userProfile.address);
                });
                $("#btn-change-address").on('click', function() {
                  var address = $("#js-new-address").val();
                  accInfoRef.update({
                    address: address
                  }).then(function() {
                    $("#change-address-popup > #success-in-popup").text("Address updated.").show();
                  });
                });
              }
            });

          },
          close: function() {
            // Will fire when popup is closed
            $("#change-address-popup > #success-in-popup").hide();
          }
        }
      });



      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          var userID = user.uid;
          var membershipPlan = new Object();
          var accInfoRef = firebase.database().ref('/account_Info/' + userID);
          var memPlanRef = firebase.database().ref('/membership_Plan/' + userID + '/');
          accInfoRef.once('value', function(data) {
            var userProfile = data.val();
            $('#profile-picture').attr('src', userProfile.profilePic);
            $('#display-profile-picture').attr('src', userProfile.profilePic);
            $('#profile-name').text(userProfile.fname + ' ' + userProfile.lname);
            $('#profile-email').text(userProfile.email);
            $('#profile-nric').text(userProfile.nric);
            $('#profile-address').text(userProfile.address);
          });

          memPlanRef.once('value', function(data) {
            var memPlan = data.val();
            console.log(memPlan.member_type == null);
            if (memPlan.member_type == null) {
              $("#membership-info").append("<p class=\"data-field\">You're not subscribe to any plan.</p>");
            } else {
              var planInfoRef = firebase.database().ref('/membership_Info/' + memPlan.member_type);
              planInfoRef.once('value', function(data) {
                var membershipInfo = data.val();
                $("#membership-info").append("<p class=\"title-field\">Membership ID:</p><p class=\"data-field\">" + membershipInfo.membershipId + "</p><p class=\"title-field\">Membership Name:</p><p class=\"data-field\">" +
                  membershipInfo.membershipName + "</p><p class=\"title-field\">Membership Type:</p><p class=\"data-field\">" + membershipInfo.membershipType +
                  "</p><p class=\"title-field\">Membership Description:</p><p class=\"data-field\">" + membershipInfo.membershipDesc + "</p><p class=\"title-field\">Validity:</p>")
                if (membershipInfo.membershipType == "prepaid") {
                  $("#membership-info").append("<p class=\"data-field\">" + membershipInfo.membershipVisits + "times" + "</p>");
                } else {
                  $("#membership-info").append("<p class=\"data-field\">" + membershipInfo.membershipMonth + " times" + "</p>");
                  $("#membership-info").append("<p class=\"data-field\">Date: " + memPlan.member_start + " to " + memPlan.member_end + "</p>");
                }
              });
            }
          });
        }
      });



    });

    function getToday() {
      var d = new Date();
      var today = new Object;
      today.Month = d.getMonth() + 1;
      today.Year = d.getFullYear();
      today.Date = d.getDate();
      var todayString = (d.getMonth() + 1) + '/' + d.getDate() + '/' + d.getFullYear();
      return today;
    }

    function getDateString(date) {
      var dateString = date.Month + '/' + date.Date + '/' + date.Year;
      return dateString;
    }

    function getTarget(Month) {
      var today = getToday();
      var target = new Object();
      target.Month = (today.Month + Month) % 12;
      target.Year = Math.floor((today.Month + Month) / 12) + today.Year;
      target.Date = today.Date;
      return target;
    }

    function greaterDate(date1, date2) {
      return (Date.parse(date1) > Date.parse(date2));
    }
  </script>



</body>

</html>
